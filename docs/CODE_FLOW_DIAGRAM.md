# Complete Code Flow Diagram

## ğŸ”„ Full Request Flow (User â†’ Database)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     USER TYPES IN FRONTEND                            â”‚
â”‚              "Create patient John Doe with diabetes"                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ HTTP POST
                             â”‚ http://localhost:8000/api/v1/command
                             â”‚ { "content": "Create patient John Doe with diabetes" }
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FRONTEND: frontend-angular/src/app/chat/chat.service.ts            â”‚
â”‚                                                                       â”‚
â”‚  sendMessage(content: string) {                                      â”‚
â”‚    return this.http.post(                                            â”‚
â”‚      'http://localhost:8000/api/v1/command',                        â”‚
â”‚      { content: content }                                            â”‚
â”‚    );                                                                â”‚
â”‚  }                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ HTTP Request
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BACKEND: backend/app/api/v1/endpoints/command.py                   â”‚
â”‚                                                                       â”‚
â”‚  @router.post("/command")                                            â”‚
â”‚  async def process_command(request: CommandRequest):                â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚      â”‚ 1. Receives: { "content": "..." }     â”‚                     â”‚
â”‚      â”‚ 2. Calls AI Service                    â”‚                     â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                                       â”‚
â”‚      result = await ai_service.process_command(request.content)     â”‚
â”‚      return CommandResponse(success=True, message=result)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ Function Call
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI SERVICE: backend/app/services/ai_service.py                     â”‚
â”‚                                                                       â”‚
â”‚  async def process_command(self, user_message: str):                â”‚
â”‚                                                                       â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚      â”‚ STEP 1: Send to OpenAI for extraction          â”‚            â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚      response = openai.ChatCompletion.create(                        â”‚
â”‚          model="gpt-4-turbo-preview",                               â”‚
â”‚          messages=[                                                  â”‚
â”‚              {                                                       â”‚
â”‚                  "role": "system",                                   â”‚
â”‚                  "content": "Extract patient data..."              â”‚
â”‚              },                                                      â”‚
â”‚              {                                                       â”‚
â”‚                  "role": "user",                                     â”‚
â”‚                  "content": "Create patient John Doe with diabetes" â”‚
â”‚              }                                                       â”‚
â”‚          ]                                                           â”‚
â”‚      )                                                               â”‚
â”‚                                                                       â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚      â”‚ STEP 2: Parse AI response                      â”‚            â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚      patient_data = {                                                â”‚
â”‚          "first_name": "John",                                      â”‚
â”‚          "last_name": "Doe",                                        â”‚
â”‚          "diagnosis": "diabetes",                                    â”‚
â”‚          "mrn": "MRN20251117101530"                                 â”‚
â”‚      }                                                               â”‚
â”‚                                                                       â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚      â”‚ STEP 3: Create HL7 message                     â”‚            â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚      hl7_message = self.hl7_service.create_adt_a04_message(         â”‚
â”‚          patient_data                                                â”‚
â”‚      )                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ Function Call
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HL7 SERVICE: backend/app/services/hl7_service.py                   â”‚
â”‚                                                                       â”‚
â”‚  def create_adt_a04_message(self, patient_data: dict) -> str:      â”‚
â”‚                                                                       â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚      â”‚ USES LIBRARY: hl7apy                           â”‚            â”‚
â”‚      â”‚ from hl7apy.core import Message                â”‚            â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                       â”‚
â”‚      # Create HL7 message structure                                  â”‚
â”‚      msg = Message("ADT_A04", version="2.5")                        â”‚
â”‚                                                                       â”‚
â”‚      # Populate MSH (Message Header)                                 â”‚
â”‚      msg.msh.msh_3 = "InterfaceWizard"                              â”‚
â”‚      msg.msh.msh_9 = "ADT^A04"                                      â”‚
â”‚      msg.msh.msh_10 = "MSG20251117101530"                           â”‚
â”‚                                                                       â”‚
â”‚      # Populate PID (Patient Identification)                         â”‚
â”‚      msg.pid.pid_3 = "MRN20251117101530^^^MRN"                      â”‚
â”‚      msg.pid.pid_5 = "Doe^John"                                     â”‚
â”‚      msg.pid.pid_7 = "19800101"                                     â”‚
â”‚      msg.pid.pid_8 = "M"                                            â”‚
â”‚                                                                       â”‚
â”‚      # Add DG1 (Diagnosis)                                           â”‚
â”‚      dg1 = Segment("DG1")                                            â”‚
â”‚      dg1.dg1_4 = "diabetes"                                         â”‚
â”‚      msg.add(dg1)                                                    â”‚
â”‚                                                                       â”‚
â”‚      # Convert to ER7 format (pipe-delimited string)                 â”‚
â”‚      hl7_string = msg.to_er7()                                       â”‚
â”‚                                                                       â”‚
â”‚      return hl7_string                                               â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ OUTPUT (HL7 Message in ER7 Format):                      â”‚       â”‚
â”‚  â”‚                                                           â”‚       â”‚
â”‚  â”‚ MSH|^~\&|InterfaceWizard|Facility|||20251117101530||    â”‚       â”‚
â”‚  â”‚     ADT^A04|MSG20251117101530|P|2.5                      â”‚       â”‚
â”‚  â”‚ EVN|A04|20251117101530                                   â”‚       â”‚
â”‚  â”‚ PID|1||MRN20251117101530^^^MRN||Doe^John||19800101|M    â”‚       â”‚
â”‚  â”‚ DG1|1|||diabetes                                         â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ Return hl7_string
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BACK TO AI SERVICE                                                  â”‚
â”‚                                                                       â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚      â”‚ STEP 4: Send HL7 to Mirth via MLLP             â”‚            â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚      result = self.mllp_client.send_message(hl7_message)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ Function Call
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MLLP CLIENT: backend/app/services/mllp_client.py                   â”‚
â”‚                                                                       â”‚
â”‚  def send_message(self, hl7_message: str) -> dict:                  â”‚
â”‚                                                                       â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚      â”‚ USES LIBRARY: socket (built-in Python)         â”‚            â”‚
â”‚      â”‚ import socket                                   â”‚            â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                       â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚      â”‚ READS CONFIG: from .env file                   â”‚            â”‚
â”‚      â”‚ MLLP_HOST = localhost                           â”‚            â”‚
â”‚      â”‚ MLLP_PORT = 6661                                â”‚            â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                       â”‚
â”‚      # Wrap HL7 with MLLP envelope                                   â”‚
â”‚      VT = b'\x0b'    # Start Block                                  â”‚
â”‚      FS = b'\x1c'    # End Block                                    â”‚
â”‚      CR = b'\x0d'    # Carriage Return                              â”‚
â”‚                                                                       â”‚
â”‚      mllp_msg = VT + hl7_message.encode('utf-8') + FS + CR          â”‚
â”‚                                                                       â”‚
â”‚      # Create TCP socket                                             â”‚
â”‚      sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)       â”‚
â”‚      sock.settimeout(30)                                             â”‚
â”‚                                                                       â”‚
â”‚      # Connect to Mirth                                              â”‚
â”‚      sock.connect(('localhost', 6661))                              â”‚
â”‚                                                                       â”‚
â”‚      # Send message                                                  â”‚
â”‚      sock.sendall(mllp_msg)                                          â”‚
â”‚                                                                       â”‚
â”‚      # Receive ACK                                                   â”‚
â”‚      response = sock.recv(4096)                                      â”‚
â”‚                                                                       â”‚
â”‚      # Close connection                                              â”‚
â”‚      sock.close()                                                    â”‚
â”‚                                                                       â”‚
â”‚      return {                                                        â”‚
â”‚          "success": True,                                            â”‚
â”‚          "ack": response.decode('utf-8')                            â”‚
â”‚      }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ TCP/IP Connection
                             â”‚ Protocol: MLLP over TCP
                             â”‚ localhost:6661
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MIRTH CONNECT CHANNEL: "Interface Wizard HL7 Listener"            â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ SOURCE CONNECTOR: MLLP Listener                        â”‚         â”‚
â”‚  â”‚ - Listening on: 0.0.0.0:6661                          â”‚         â”‚
â”‚  â”‚ - Receives: <VT>MSH|...<FS><CR>                       â”‚         â”‚
â”‚  â”‚ - Strips MLLP envelope                                 â”‚         â”‚
â”‚  â”‚ - Parses HL7 into object                               â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                             â”‚                                         â”‚
â”‚                             â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ SOURCE TRANSFORMER: JavaScript Code                    â”‚         â”‚
â”‚  â”‚                                                         â”‚         â”‚
â”‚  â”‚  var pid = msg['PID'];                                 â”‚         â”‚
â”‚  â”‚  var firstName = safe(pid['PID.5'], 'PID.5.2');       â”‚         â”‚
â”‚  â”‚    â†’ "John"                                            â”‚         â”‚
â”‚  â”‚  var lastName = safe(pid['PID.5']['PID.5.1']...);     â”‚         â”‚
â”‚  â”‚    â†’ "Doe"                                             â”‚         â”‚
â”‚  â”‚  var patientMRN = safe(pid['PID.3'], 'PID.3.1');      â”‚         â”‚
â”‚  â”‚    â†’ "MRN20251117101530"                               â”‚         â”‚
â”‚  â”‚                                                         â”‚         â”‚
â”‚  â”‚  // Connect to MySQL                                   â”‚         â”‚
â”‚  â”‚  dbConn = DatabaseConnectionFactory.create(            â”‚         â”‚
â”‚  â”‚      'com.mysql.cj.jdbc.Driver',                       â”‚         â”‚
â”‚  â”‚      'jdbc:mysql://localhost:3306/openemr',            â”‚         â”‚
â”‚  â”‚      'openemr',                                        â”‚         â”‚
â”‚  â”‚      'openemr'                                         â”‚         â”‚
â”‚  â”‚  );                                                     â”‚         â”‚
â”‚  â”‚                                                         â”‚         â”‚
â”‚  â”‚  // Get next patient ID                                â”‚         â”‚
â”‚  â”‚  nextPidSql = "SELECT MAX(pid) + 1 FROM patient_data"; â”‚         â”‚
â”‚  â”‚  nextPid = 13                                          â”‚         â”‚
â”‚  â”‚                                                         â”‚         â”‚
â”‚  â”‚  // Insert patient                                     â”‚         â”‚
â”‚  â”‚  insertSql = "INSERT INTO patient_data                 â”‚         â”‚
â”‚  â”‚      (pid, fname, lname, pubpid, ...)                  â”‚         â”‚
â”‚  â”‚      VALUES (13, 'John', 'Doe', 'MRN...', ...)";       â”‚         â”‚
â”‚  â”‚                                                         â”‚         â”‚
â”‚  â”‚  dbConn.executeUpdate(insertSql);                      â”‚         â”‚
â”‚  â”‚  // SUCCESS! Row inserted                              â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                             â”‚                                         â”‚
â”‚                             â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ DESTINATION: File Writer                               â”‚         â”‚
â”‚  â”‚ - Saves to: C:/mirth/hl7_messages/                    â”‚         â”‚
â”‚  â”‚ - Filename: MSG_20251117_abc123.hl7                   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                             â”‚                                         â”‚
â”‚                             â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ ACK RESPONSE                                           â”‚         â”‚
â”‚  â”‚ MSH|...|ACK|...                                        â”‚         â”‚
â”‚  â”‚ MSA|AA|MSG20251117101530                               â”‚         â”‚
â”‚  â”‚     ^^                                                 â”‚         â”‚
â”‚  â”‚     â””â”€ AA = Application Accept (Success)              â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ TCP Response
                             â”‚ ACK sent back to backend
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MLLP CLIENT (receives ACK)                                          â”‚
â”‚                                                                       â”‚
â”‚  return {                                                            â”‚
â”‚      "success": True,                                                â”‚
â”‚      "ack": "MSH|...|ACK|...\rMSA|AA|MSG20251117101530"            â”‚
â”‚  }                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ Return to AI Service
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI SERVICE (receives result)                                        â”‚
â”‚                                                                       â”‚
â”‚  if result['success']:                                               â”‚
â”‚      return {                                                        â”‚
â”‚          'message': 'Patient John Doe created successfully!'        â”‚
â”‚      }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ Return to API endpoint
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API ENDPOINT (returns response)                                     â”‚
â”‚                                                                       â”‚
â”‚  return CommandResponse(                                             â”‚
â”‚      success=True,                                                   â”‚
â”‚      message='Patient John Doe created successfully!'               â”‚
â”‚  )                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ HTTP Response (JSON)
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FRONTEND (receives response)                                        â”‚
â”‚                                                                       â”‚
â”‚  {                                                                   â”‚
â”‚      "success": true,                                                â”‚
â”‚      "message": "Patient John Doe created successfully!"            â”‚
â”‚  }                                                                   â”‚
â”‚                                                                       â”‚
â”‚  Display in chat interface:                                          â”‚
â”‚  âœ“ Patient John Doe created successfully!                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OPENEMR DATABASE                                                    â”‚
â”‚                                                                       â”‚
â”‚  patient_data table:                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ pid â”‚ fname  â”‚ lname â”‚ pubpid           â”‚ regdate      â”‚         â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚
â”‚  â”‚ 13  â”‚ John   â”‚ Doe   â”‚ MRN20251117...   â”‚ 2025-11-17   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

USER SEES: "Patient John Doe created successfully!" âœ“
DATABASE HAS: New patient record with pid=13 âœ“
```

---

## ğŸ” Key Files and Their Roles

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FILE DEPENDENCY MAP                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

.env
  â†“ loaded by
config.py (settings object)
  â†“ used by
mllp_client.py (MLLP_HOST, MLLP_PORT)
hl7_service.py (no direct config needed)
ai_service.py (OPENAI_API_KEY)
  â†“ used by
command.py (API endpoint)
  â†“ called by
main.py (FastAPI app)
  â†“ started by
uvicorn (run command)
```

---

## ğŸ“¦ Library Usage Map

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LIBRARIES AND WHERE THEY'RE USED                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

hl7apy
  â””â”€ Used in: hl7_service.py
  â””â”€ Purpose: Create HL7 messages
  â””â”€ Key classes: Message, Segment

socket (built-in)
  â””â”€ Used in: mllp_client.py
  â””â”€ Purpose: TCP/IP communication with Mirth
  â””â”€ Key functions: socket(), connect(), sendall(), recv()

fastapi
  â””â”€ Used in: main.py, command.py
  â””â”€ Purpose: REST API framework
  â””â”€ Key classes: FastAPI, APIRouter

openai
  â””â”€ Used in: ai_service.py
  â””â”€ Purpose: Natural language processing
  â””â”€ Key functions: ChatCompletion.create()

pydantic
  â””â”€ Used in: config.py, models/
  â””â”€ Purpose: Data validation and settings
  â””â”€ Key classes: BaseSettings, BaseModel

pymysql + sqlalchemy
  â””â”€ Used in: database_service.py (optional, for direct DB access)
  â””â”€ Purpose: Direct database queries (if needed)
  â””â”€ Note: Mirth does the actual patient insert!
```

---

## ğŸ”§ Configuration Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HOW CONFIGURATION FLOWS THROUGH THE SYSTEM                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. Developer creates .env file:
   MLLP_HOST=localhost
   MLLP_PORT=6661
   OPENAI_API_KEY=sk-...

2. config.py loads .env on startup:
   from pydantic_settings import BaseSettings

   class Settings(BaseSettings):
       MLLP_HOST: str = "localhost"
       MLLP_PORT: int = 6661
       ...
       class Config:
           env_file = ".env"

   settings = Settings()  # Auto-loads .env

3. Services import settings:
   from app.config import settings

   client = MLLPClient(
       host=settings.MLLP_HOST,
       port=settings.MLLP_PORT
   )

4. Runtime usage:
   sock.connect((settings.MLLP_HOST, settings.MLLP_PORT))
   # Connects to localhost:6661
```

---

## ğŸ“ Complete File Checklist with Line Counts

| File | Lines | Purpose | Key Libraries |
|------|-------|---------|---------------|
| `.env` | 56 | Configuration | - |
| `config.py` | 80 | Load settings | pydantic_settings |
| `hl7_service.py` | 150 | Create HL7 | hl7apy |
| `mllp_client.py` | 180 | Send to Mirth | socket |
| `ai_service.py` | 120 | Process commands | openai |
| `command.py` | 50 | API endpoint | fastapi |
| `main.py` | 100 | Application | fastapi |
| `requirements.txt` | 20 | Dependencies | - |

**Total: ~756 lines of backend code to integrate with Mirth**

---

## ğŸ¯ Key Takeaways

1. **Libraries Used:**
   - `hl7apy` - Creates HL7 messages
   - `socket` - Sends via MLLP protocol
   - `fastapi` - REST API framework
   - `openai` - AI processing

2. **Configuration Files:**
   - `.env` - All settings
   - `config.py` - Loads .env
   - `requirements.txt` - Dependencies

3. **Key Files:**
   - `hl7_service.py` - Builds HL7 messages
   - `mllp_client.py` - Sends to Mirth
   - `ai_service.py` - Orchestrates everything

4. **Critical Settings:**
   - `MLLP_HOST=localhost`
   - `MLLP_PORT=6661` (must match Mirth channel)
   - `OPENAI_API_KEY=sk-...`

---

**Created:** 2025-11-17
**Purpose:** Visual guide to code flow and dependencies
